<!DOCTYPE html>
<html>
<head>
<title>Final Code</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
<link rel="stylesheet" href="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />

<style type="text/css">
.center{
    text-align: center;
}
.left{
    text-align: left;
    font-weight: bold;
}
.right{
    text-align: right;
    font-weight: bold;
}
.big{
    font-size: large;
    font-weight: bold;
}
.red{
    /*color: red;*/
    background-color: red;
}
.blink_me {
  animation: blinker 1s linear infinite;
}

@keyframes blinker {
  50% { opacity: 0; }
}

</style>
<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script type="text/javascript">
var config = {
    maxNum : 99,
    oneBlockNum : 5,
    space : ' ',
    comma : ',',
    brn : "\n"
}

var stringTrim = function(string){
    var trimOfString = '';
    if( 'string' == typeof string ){
        trimOfString = string.trim();
    }
    return trimOfString;
}

var stringToArray = function(string, separator) {
    var arrayOfStrings = [];
    if( 'string' == typeof string ){
        arrayOfStrings = string.split(separator);
    }
    return arrayOfStrings;
}
var arrayToString = function(array, separator){
    var stringOfArray = '';
    if( 'object' == typeof array ){
        stringOfArray = array.join(separator);
    }
    return stringOfArray;
}

// 計算連線
var countLine = function(winBlockIndex)
{
    
    var line = 0;
    if( 
        -1 !== winBlockIndex.indexOf(0, 0) 
        && -1 !== winBlockIndex.indexOf(1, 0) 
        && -1 !== winBlockIndex.indexOf(2, 0) 
        && -1 !== winBlockIndex.indexOf(3, 0) 
        && -1 !== winBlockIndex.indexOf(4, 0) 
    ){
        // 橫1
        line++;
    }
    
    if( 
        -1 !== winBlockIndex.indexOf(5, 0) 
        && -1 !== winBlockIndex.indexOf(6, 0) 
        && -1 !== winBlockIndex.indexOf(7, 0) 
        && -1 !== winBlockIndex.indexOf(8, 0) 
        && -1 !== winBlockIndex.indexOf(9, 0) 
    ){
        // 橫2
        line++;
    }
    
    if( 
        -1 !== winBlockIndex.indexOf(10, 0) 
        && -1 !== winBlockIndex.indexOf(11, 0) 
        && -1 !== winBlockIndex.indexOf(12, 0) 
        && -1 !== winBlockIndex.indexOf(13, 0) 
        && -1 !== winBlockIndex.indexOf(14, 0) 
    ){
        // 橫3
        line++;
    }
    
    if( 
        -1 !== winBlockIndex.indexOf(15, 0) 
        && -1 !== winBlockIndex.indexOf(16, 0) 
        && -1 !== winBlockIndex.indexOf(17, 0) 
        && -1 !== winBlockIndex.indexOf(18, 0) 
        && -1 !== winBlockIndex.indexOf(19, 0) 
    ){
        // 橫4
        line++;
    }
    
    if( 
        -1 !== winBlockIndex.indexOf(20, 0) 
        && -1 !== winBlockIndex.indexOf(21, 0) 
        && -1 !== winBlockIndex.indexOf(22, 0) 
        && -1 !== winBlockIndex.indexOf(23, 0) 
        && -1 !== winBlockIndex.indexOf(24, 0) 
    ){
        // 橫5
        line++;
    }
    
    if( 
        -1 !== winBlockIndex.indexOf(0, 0) 
        && -1 !== winBlockIndex.indexOf(5, 0) 
        && -1 !== winBlockIndex.indexOf(10, 0) 
        && -1 !== winBlockIndex.indexOf(15, 0) 
        && -1 !== winBlockIndex.indexOf(20, 0) 
    ){
        // 直1
        line++;
    }
    
    if( 
        -1 !== winBlockIndex.indexOf(1, 0) 
        && -1 !== winBlockIndex.indexOf(6, 0) 
        && -1 !== winBlockIndex.indexOf(11, 0) 
        && -1 !== winBlockIndex.indexOf(16, 0) 
        && -1 !== winBlockIndex.indexOf(21, 0) 
    ){
        // 直2
        line++;
    }
    
    if( 
        -1 !== winBlockIndex.indexOf(2, 0) 
        && -1 !== winBlockIndex.indexOf(7, 0) 
        && -1 !== winBlockIndex.indexOf(12, 0) 
        && -1 !== winBlockIndex.indexOf(17, 0) 
        && -1 !== winBlockIndex.indexOf(22, 0) 
    ){
        // 直3
        line++;
    }
    
    if( 
        -1 !== winBlockIndex.indexOf(3, 0) 
        && -1 !== winBlockIndex.indexOf(8, 0) 
        && -1 !== winBlockIndex.indexOf(13, 0) 
        && -1 !== winBlockIndex.indexOf(18, 0) 
        && -1 !== winBlockIndex.indexOf(23, 0) 
    ){
        // 直4
        line++;
    }
    
    if( 
        -1 !== winBlockIndex.indexOf(4, 0) 
        && -1 !== winBlockIndex.indexOf(9, 0) 
        && -1 !== winBlockIndex.indexOf(14, 0) 
        && -1 !== winBlockIndex.indexOf(19, 0) 
        && -1 !== winBlockIndex.indexOf(24, 0) 
    ){
        // 直5
        line++;
    }
    
    if( 
        -1 !== winBlockIndex.indexOf(0, 0) 
        && -1 !== winBlockIndex.indexOf(6, 0) 
        && -1 !== winBlockIndex.indexOf(12, 0) 
        && -1 !== winBlockIndex.indexOf(18, 0) 
        && -1 !== winBlockIndex.indexOf(24, 0) 
    ){
        // 斜 \
        line++;
    }
    
    if( 
        -1 !== winBlockIndex.indexOf(4, 0) 
        && -1 !== winBlockIndex.indexOf(8, 0) 
        && -1 !== winBlockIndex.indexOf(12, 0) 
        && -1 !== winBlockIndex.indexOf(16, 0) 
        && -1 !== winBlockIndex.indexOf(20, 0) 
    ){
        // 斜 /
        line++;
    }
    
    return line;
}

// 兌獎結果顯示元件
var showComponent = function()
{
    //console.log('showComponent');
    
    // 取得目前已經設定的 開獎號碼
    var openNumStr = stringTrim(localStorage["openNumStr"]);
    var openNumAry = stringToArray(openNumStr, config.space);
    
    // 取得目前已經設定的 下注號碼
    var chooseNumStr = stringTrim(localStorage["chooseNumStr"]);
    var chooseNumAry = stringToArray(chooseNumStr, config.brn);
    
    // 使用 choose 來畫 樂透格子
    
    var showBlock = $('#showBlock');
    showBlock.empty();
    
    chooseNumAry.forEach(function(currentValue){
        // 把內容數字 拆解
        //console.log(currentValue);
        var currentValueStr = stringTrim(currentValue);
        var currentValueAry = stringToArray(currentValueStr, config.space);
        
        //console.log(currentValueAry);
        if( config.oneBlockNum * config.oneBlockNum  == currentValueAry.length ){
            // 驗證卷的數字數量必須為一張卷的數量，不然無視
            
            var winBlockIndex = [];
            
            // 組合成 5*5 的table
            var table = $('<table></table>').attr('border', 1);
            
            for(y=1;y<=config.oneBlockNum;y++){
                
                var tr = $('<tr></tr>');
                
                for(x=1;x<=config.oneBlockNum;x++){
                    
                    var index = ( y - 1 ) * config.oneBlockNum + x - 1;
                    var td = $('<td></td>');
                    var thisBlockNum = currentValueAry[index];
                    if( -1 !== openNumAry.indexOf(thisBlockNum, 0) ){
                        td.addClass('red');
                        winBlockIndex.push(index);
                    }
                    
                    td.html(thisBlockNum);
                    
                    tr.append(td);
                }
                table.append(tr);
            }
            
            var line = countLine(winBlockIndex);
            
            var span = $('<span></span>').append("(" + line +")");
            if(line >= 5){
                span.addClass('blink_me');
            }
            
            // 顯示在 list 上
            var li = $('<li></li>');
            li.css('white-space','normal').html(table).append(span);
            
            showBlock.append(li);
        }
    }, this)
    
    showBlock.listview('refresh');
}

// 建立開獎號碼元件
var createOpenComponent = function()
{
    // 取得目前已經設定的 開獎號碼
    var openNumStr = stringTrim(localStorage["openNumStr"]);
    var openNumAry = stringToArray(openNumStr, config.space);
    
    // 清空
    var openBlock = $('#openBlock');
    openBlock.empty();
    // 建立 1~maxNum 按鈕於畫面
    for(i=1;i<=config.maxNum;i++){
        
        var iStr = "" + i;
        
        // 
        var button = $("<button></button>").addClass("setNum ui-btn ui-corner-all").text(i);
        var btndivClass = "";
        btnClass = ( openNumAry.indexOf(iStr) === -1)?'':'ui-btn-b';
        button.addClass(btnClass);
        
        //
        var div = $("<div></div>").html(button);
        var divClass = "";
        divClass = (1 == i % 5)?'ui-block-a':divClass;
        divClass = (2 == i % 5)?'ui-block-b':divClass;
        divClass = (3 == i % 5)?'ui-block-c':divClass;
        divClass = (4 == i % 5)?'ui-block-d':divClass;
        divClass = (0 == i % 5)?'ui-block-e':divClass;
        div.addClass(divClass);
        
        openBlock.append(div);
    }
    
    // 綁定 開獎功能
    $('.setNum').on('click', function(){
        // 號碼
        var num = $(this).text();
        
        if(true == $(this).hasClass('ui-btn-b')){
            // 換色 白
            $(this).removeClass('ui-btn-b');
            // 開獎資料移除 num
            var key = openNumAry.indexOf(num);
            if( -1 !== key ){
                openNumAry.splice(key, 1)
            }
            
        }else{
            // 換色 黑
            $(this).addClass('ui-btn-b');
            // 開獎資料加入 num
            openNumAry.push(num);
        }
        
        openNumStr = arrayToString(openNumAry, config.space)
        localStorage.openNumStr = openNumStr;
        
        // 重畫 顯示區塊
        showComponent();
    })
}

// 下注項目
var listChooseNumComponent = function()
{
    // 取得目前已經設定的 下注號碼
    var chooseNumStr = stringTrim(localStorage["chooseNumStr"]);
    var chooseNumAry = stringToArray(chooseNumStr, config.brn);
    
    var chooseBlock = $('#chooseBlock');
    
    chooseBlock.empty();
    
    chooseNumAry.forEach(function(currentValue){
        
        var currentValueStr = stringTrim(currentValue);
        if('' != currentValueStr){
            var currentValueAry = stringToArray(currentValueStr, config.space);
            
            chooseBlock.append($('<li></li>').css('white-space','normal').html( "(" + currentValueAry.length + ")" + currentValue ));
        }
    }, this)
    
    chooseBlock.listview('refresh');
}

$(document).ready(init);    // 網頁完成後，呼叫 init
function init(){
    
    $(document).on('pagebeforeshow', '#main', function(){
        // 顯示 元件
        showComponent();
        
        // 建立 開獎 元件
        createOpenComponent();
        
        // 把儲存的資料讀出
        $('#inputArea').val(localStorage["chooseNumStr"]);
        
        // 建立彩票資料
        listChooseNumComponent();
        
    });
    
    // 設定 紀錄
    $('#storageSave').on('click', function(){
        // 
        localStorage.chooseNumStr = $('#inputArea').val();
        showComponent();
        listChooseNumComponent();
    });
    $('#storageLoad').on('click', function(){
        // 
        $('#inputArea').val(localStorage["chooseNumStr"]);
        listChooseNumComponent();
    });
    $('#storageClear').on('click', function(){
        localStorage.clear();
        showComponent();
        createOpenComponent();
        listChooseNumComponent();
    });
    $('#storageTest').on('click', function(){
        if (typeof(Storage) !== "undefined") {
            alert('Code for localStorage/sessionStorage.');
        } else {
            alert('Sorry! No Web Storage support..');
        }
    });
}

</script>

<script src="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>

</head>
<body>
<div id="main" data-role="page">
    <div data-role="header">
        <a href="#info" 
            class='ui-btn ui-btn-inline ui-mini ui-corner-all ui-btn-icon-left ui-icon-info'
        >規則</a>
        <h1>樂透</h1>
    </div>
    <div data-role="content">
        <div data-role="tabs" id="tabs">
            <div data-role="navbar">
                <ul>
                    <li><a href="#one" data-ajax="false">顯示</a></li>
                    <li><a href="#two" data-ajax="false">開獎</a></li>
                    <li><a href="#three" data-ajax="false">設定</a></li>
                </ul>
            </div>
            
            <div id="one" class="">
                依照 web storage 處理顯示資料
                <br>
                <ul data-role="listview" data-inset="true" id="showBlock">
                    <!--區塊顯示-->
                </ul>
            </div>
            
            <div id="two" class="center">
                把所有號碼列出，點亮為開 點暗為未開
                <br>
                <div class="ui-grid-d" id="openBlock">
                    <!--開獎號碼-->
                </div>
                
            </div>
            
            <div id="three">
                設定自己的號碼進 web storage
                <textarea id="inputArea" ></textarea>
                <div class="ui-grid-c">
                    <div class="ui-block-a"><button id="storageSave">儲存</button></div>
                    <div class="ui-block-b"><button id="storageLoad">載入</button></div>
                    <div class="ui-block-c"><button id="storageClear">清除</button></div>
                    <div class="ui-block-d"><button id="storageTest">測試</button></div>
                </div>
                
                <ul data-role="listview" data-inset="true" id="chooseBlock">
                    <!--下注號碼-->
                </ul>
                
            </div>
            
        </div>
    </div>
</div>

<div id="info" data-role="page" data-add-back-btn="true">
    <div data-role="header">
        <a href="#main" data-rel="back" 
            class="ui-btn ui-btn-inline ui-mini ui-corner-all ui-btn-icon-left ui-icon-carat-l">
            Back
        </a>
        <h1>遊戲規則</h1>
    </div>
    <div data-role="content">
        123
    </div>

</div>
</body>
</html>
